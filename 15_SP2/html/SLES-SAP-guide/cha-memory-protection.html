<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><title>SLES for SAP 15 SP2 | Guide | Tuning Workload Memory Protection</title><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes"/><link rel="stylesheet" type="text/css" href="static/css/style.css"/>
<link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"/><link rel="schema.DCTERMS" href="http://purl.org/dc/terms/"/>
<meta name="title" content="Tuning Workload Memory Protection | SLES for SAP 15 SP2"/>
<meta name="description" content="If you have systemd-based SAP instances, read Section 10.9, “Systems running both systemd-based and regular SAP instances” and Section 10.10, “System…"/>
<meta name="product-name" content="SUSE Linux Enterprise Server for SAP Applications"/>
<meta name="product-number" content="15 SP2"/>
<meta name="book-title" content="Guide"/>
<meta name="chapter-title" content="Chapter 10. Tuning Workload Memory Protection"/>
<meta name="tracker-url" content="https://bugzilla.suse.com/enter_bug.cgi"/>
<meta name="tracker-type" content="bsc"/>
<meta name="tracker-bsc-assignee" content="dmitri.popov@suse.com"/>
<meta name="tracker-bsc-component" content="Documentation"/>
<meta name="tracker-bsc-product" content="SUSE Linux Enterprise Server for SAP Applications 15 SP2"/>
<meta name="publisher" content="SUSE"/><meta property="og:title" content="Tuning Workload Memory Protection | SLES for SAP 15 SP2"/>
<meta property="og:description" content="If you have systemd-based SAP instances, read Section 10.9,…"/>
<meta property="og:type" content="article"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Tuning Workload Memory Protection | SLES for SAP 15 SP2"/>
<meta name="twitter:description" content="If you have systemd-based SAP instances, read Section 10.9,…"/>
<script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": ["TechArticle"],
    "image": "https://www.suse.com/assets/img/suse-white-logo-green.svg",
    
    "inLanguage": "en",
    
    "headline": "Tuning Workload Memory Protection",
  
    "description": "Tuning Workload Memory Protection",
      
    "author": [
      {
        "@type": "Corporation",
        "name": "SUSE Product &amp; Solution Documentation Team",
        "url": "https://www.suse.com/assets/img/suse-white-logo-green.svg"
      }
    ],
      
    "dateModified": "2024-03-27T00:00+02:00",
      

    "about": [
      
    ],
  
    "sameAs": [
          "https://www.facebook.com/SUSEWorldwide/about",
          "https://www.youtube.com/channel/UCHTfqIzPKz4f_dri36lAQGA",
          "https://twitter.com/SUSE",
          "https://www.linkedin.com/company/suse"
    ],
    "publisher": {
      "@type": "Corporation",
      "name": "SUSE",
      "url": "https://documentation.suse.com",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.suse.com/assets/img/suse-white-logo-green.svg"
      }
    }
  }</script>
<link rel="prev" href="cha-tune.html" title="Chapter 9. Tuning systems with saptune"/><link rel="next" href="cha-access.html" title="Chapter 11. Firewalling"/><script type="text/javascript">

if ( window.location.protocol.toLowerCase() != 'file:' ) {
  document.write('<link rel="stylesheet" type="text/css" href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css"></link>');
};

</script><noscript><link rel="stylesheet" type="text/css" href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css"/></noscript><script src="static/js/script-purejs.js" type="text/javascript"> </script><script src="static/js/highlight.min.js" type="text/javascript"> </script><script>

$(document).ready(function() {
  $('.verbatim-wrap.highlight').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});
hljs.configure({
  useBR: false
});

</script><meta name="edit-url" content="https://github.com/SUSE/doc-slesforsap/edit/maintenance/15_SP2/xml/s4s_tune_wmp.xml"/></head><body class="draft wide offline js-off" onload="$('#betawarn-button-wrap').toggle();if (document.cookie.length > 0) {if (document.cookie.indexOf('betawarn=closed') != -1){$('#betawarn').toggle()}};"><div id="betawarn" style="position:fixed;bottom:0;z-index:9025;background-color:#FDE8E8;padding:1em;margin-left:10%;margin-right:10%;display:block;border-top:.75em solid #E11;width:80%"><p style="color:#333;margin:1em 0;padding:0;">This is a draft document that was built and uploaded automatically. It may document beta software and be incomplete or even incorrect. <strong>Use this document at your own risk.</strong></p> <div id="betawarn-button-wrap" style="display:none;margin:0;padding:0;"><a href="#" onclick="$('#betawarn').toggle();var d=new Date();d.setTime(d.getTime()+(0.5*24*60*60*1000));document.cookie='betawarn=closed; expires='+d.toUTCString()+'; path=/'; return false;" style="color:#333;text-decoration:underline;float:left;margin-top:.5em;padding:1em;display:block;background-color:#FABEBE;">I understand this is a draft</a></div></div><div class="bypass-block"><a href="#_content">Jump to content</a><a href="#_bottom-pagination">Jump to page navigation: previous page [access key p]/next page [access key n]</a></div><header id="_mainnav"><div class="growth-inhibitor"><img src="static/images/logo.svg" alt="Logo" class="logo"/></div></header><div class="crumbs"><div class="growth-inhibitor"><a class="crumb" href="index.html">Guide</a><span> / </span><a class="crumb" href="cha-memory-protection.html">Tuning Workload Memory Protection</a></div></div><main id="_content"><nav id="_side-toc-overall" class="side-toc"><div class="side-title"><span class="phrase">Guide</span></div><ol><li><a href="pre-s4s.html" class=" "><span class="title-number"> </span><span class="title-name">About this guide</span></a></li><li><a href="cha-about.html" class=" "><span class="title-number">1 </span><span class="title-name">What is SUSE Linux Enterprise Server for SAP Applications?</span></a></li><li><a href="cha-plan.html" class=" "><span class="title-number">2 </span><span class="title-name">Planning the installation</span></a></li><li><a href="cha-install.html" class=" "><span class="title-number">3 </span><span class="title-name">Installing the operating system</span></a></li><li><a href="cha-install-sap.html" class=" "><span class="title-number">4 </span><span class="title-name">Installing SAP applications</span></a></li><li><a href="cha-upgrade-sap-hana-cluster.html" class=" "><span class="title-number">5 </span><span class="title-name">Upgrading a SAP HANA cluster</span></a></li><li><a href="cha-serve-mediaset.html" class=" "><span class="title-number">6 </span><span class="title-name">Setting up an installation server for SAP media sets</span></a></li><li><a href="cha-cluster.html" class=" "><span class="title-number">7 </span><span class="title-name">Setting up an SAP HANA cluster</span></a></li><li><a href="cha-tune-sapconf.html" class=" "><span class="title-number">8 </span><span class="title-name">Tuning systems with <code class="literal">sapconf</code></span></a></li><li><a href="cha-tune.html" class=" "><span class="title-number">9 </span><span class="title-name">Tuning systems with <code class="command">saptune</code></span></a></li><li><a href="cha-memory-protection.html" class=" you-are-here"><span class="title-number">10 </span><span class="title-name">Tuning Workload Memory Protection</span></a></li><li><a href="cha-access.html" class=" "><span class="title-number">11 </span><span class="title-name">Firewalling</span></a></li><li><a href="cha-clamsap.html" class=" "><span class="title-number">12 </span><span class="title-name">Protecting against malware with ClamSAP</span></a></li><li><a href="cha-configure-rdp.html" class=" "><span class="title-number">13 </span><span class="title-name">Connecting via RDP</span></a></li><li><a href="cha-image.html" class=" "><span class="title-number">14 </span><span class="title-name">Creating operating system images</span></a></li><li><a href="cha-trouble.html" class=" "><span class="title-number">15 </span><span class="title-name">Important log files</span></a></li><li><a href="app-additional-software.html" class=" "><span class="title-number">A </span><span class="title-name">Additional software for SLES for SAP</span></a></li><li><a href="app-autoyast-partition.html" class=" "><span class="title-number">B </span><span class="title-name">Partitioning for the SAP system using AutoYaST</span></a></li><li><a href="app-component-supplement.html" class=" "><span class="title-number">C </span><span class="title-name">Supplementary Media</span></a></li><li><a href="apd.html" class=" "><span class="title-number">D </span><span class="title-name">GNU licenses</span></a></li> </ol> </nav><button id="_open-side-toc-overall" title="Contents"> </button><article class="documentation"><button id="_unfold-side-toc-page">On this page</button><section class="chapter" id="cha-memory-protection" data-id-title="Tuning Workload Memory Protection"><div class="titlepage"><div><div class="version-info">Applies to  <span class="productname">SUSE Linux Enterprise Server for SAP Applications</span> <span class="productnumber">15 SP2</span></div><div><div class="title-container"><h1 class="title"><span class="title-number-name"><span class="title-number">10 </span><span class="title-name">Tuning Workload Memory Protection</span></span> <a title="Permalink" class="permalink" href="cha-memory-protection.html#">#</a></h1><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-slesforsap/edit/maintenance/15_SP2/xml/s4s_tune_wmp.xml" title="Edit source document"> </a></div></div></div></div></div><div id="id-1.13.2" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important</div><p>
   If you have <code class="systemitem">systemd</code>-based SAP instances, read
   <a class="xref" href="cha-memory-protection.html#sec-sap-systemd-mix-wmp" title="10.9. Systems running both systemd-based and regular SAP instances">Section 10.9, “Systems running both <code class="systemitem">systemd</code>-based and regular SAP instances”</a> and
   <a class="xref" href="cha-memory-protection.html#sec-sap-systemd-wmp" title="10.10. Systems running only systemd-based instances">Section 10.10, “Systems running only <code class="systemitem">systemd</code>-based instances”</a> before setting up Workload Memory Protection.
  </p></div><p>
  Keeping SAP applications in physical memory is essential for their
  performance. In older product versions, the Page Cache Limit prevented a swap
  out to disk by a growing page cache (in SUSE Linux Enterprise Server for SAP Applications 11 SP1 onwards and in
  SUSE Linux Enterprise Server for SAP Applications 12). In SUSE Linux Enterprise Server for SAP Applications 15, the Page Cache Limit has been
  replaced by the more advanced Workload Memory Protection.
 </p><p>
  Workload Memory Protection puts SAP instances into a dedicated cgroup (v2) and tells the kernel,
  by the <code class="varname">memory.low</code> parameter, the amount of memory to keep
  in physical memory. This protects the processes in this cgroup against any
  form of memory pressure outside that cgroup, including a growing page cache.
  Workload Memory Protection cannot protect against memory pressure inside this cgroup. It covers
  the memory of <span class="emphasis"><em>all</em></span> instances together on one host.
 </p><p>
  The value for <code class="varname">memory.low</code> depends on the kind of SAP
  instance and the workload and needs to be configured manually. If the system
  is under extreme pressure, the Linux kernel will ignore the
  <code class="varname">memory.low</code> value and try to stabilize the whole system,
  even by swapping or invoking the OOM killer.
 </p><p>
  For more information about cgroups, see
  <a class="link" href="https://documentation.suse.com/sles-15/html/SLES-all/cha-tuning-cgroups.html" target="_blank">https://documentation.suse.com/sles-15/html/SLES-all/cha-tuning-cgroups.html</a>.
 </p><section class="sect1" id="sec-memory-protection-architecture" data-id-title="Architecture"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">10.1 </span><span class="title-name">Architecture</span></span> <a title="Permalink" class="permalink" href="cha-memory-protection.html#sec-memory-protection-architecture">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-slesforsap/edit/maintenance/15_SP2/xml/s4s_tune_wmp.xml" title="Edit source document"> </a></div></div></div></div></div><p>
   WMP relies on three components:
  </p><div class="variablelist"><dl class="variablelist"><dt id="id-1.13.7.3.1"><span class="term">cgroup2 memory controller (Linux kernel)</span></dt><dd><p>
      The cgroup2 memory controller parameter <em class="parameter">memory.low</em>
      allows defining an amount of memory, which the Linux kernel will keep in
      physical memory. This amount of memory will be excluded from the
      reclaiming process unless the entire system is in a critical memory
      situation.
     </p><p>
      WMP uses <em class="parameter">memory.low</em> to prevent memory from SAP
      processes from being paged or swapped out to disk. Apart from the memory
      controller, cgroup1 controllers are still available, but are not mounted
      any more.
     </p></dd><dt id="id-1.13.7.3.2"><span class="term"><code class="systemitem">systemd</code></span></dt><dd><p>
      <code class="systemitem">systemd</code> provides the infrastructure to create and maintain the cgroup
      hierarchy and allows the configuration of cgroup parameters. WMP ships
      <code class="systemitem">systemd</code> configuration files to allow easy configuration of
      <em class="parameter">memory.low</em> via <code class="systemitem">systemd</code> methods.
     </p></dd><dt id="id-1.13.7.3.3"><span class="term">SAP start service</span></dt><dd><p>
      The SAP start service manages the starting and stopping of SAP
      instances. An important feature for WMP is the configurable execution of
      programs before the instance itself gets started in the instance profile.
      WMP uses this method to call a program to move the
      <code class="systemitem">sapstart</code> process into a designated cgroup, so
      the SAP instance will be started inside that cgroup.
     </p></dd></dl></div></section><section class="sect1" id="sec-memory-protection-support" data-id-title="Support for Workload Memory Protection"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">10.2 </span><span class="title-name">Support for Workload Memory Protection</span></span> <a title="Permalink" class="permalink" href="cha-memory-protection.html#sec-memory-protection-support">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-slesforsap/edit/maintenance/15_SP2/xml/s4s_tune_wmp.xml" title="Edit source document"> </a></div></div></div></div></div><p>
   WMP is supported for SUSE Linux Enterprise Server for SAP Applications 15 SP2 on AMD64/Intel 64 and POWER
   for one or multiple SAP systems on one host, such as:
  </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
     App Server (SAP NetWeaver, SAP S/4HANA) or
    </p></li><li class="listitem"><p>
     SAP HANA 1.0/2.0
    </p></li></ul></div><p>
   Workload Memory Protection does not cover databases other than SAP HANA. Depending on their start
   method, the processes might run inside or outside the dedicated cgroup. If
   they run inside, the memory consumption needs to be taken into account when
   determining <code class="varname">memory.low</code>.
  </p><div id="id-1.13.8.5" data-id-title="Restrictions of WMP" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important: Restrictions of WMP</div><p>
    Using WMP comes with benefits, but you should be aware of some
    restrictions:
   </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
      WMP cannot protect against memory pressure inside the dedicated cgroup.
     </p></li><li class="listitem"><p>
      WMP cannot protect SAP systems or their instances from each other. All
      SAP processes share the same memory limit. If you have multiple SAP
      systems (for example, SAP NetWeaver and SAP S/4HANA), WMP cannot shield one SAP
      application from the other.
     </p></li><li class="listitem"><p>
      Support for SUSE’s HA cluster solution is not yet available.
     </p></li></ul></div></div></section><section class="sect1" id="sec-memory-protection-setup" data-id-title="Setting up Workload Memory Protection"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">10.3 </span><span class="title-name">Setting up Workload Memory Protection</span></span> <a title="Permalink" class="permalink" href="cha-memory-protection.html#sec-memory-protection-setup">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-slesforsap/edit/maintenance/15_SP2/xml/s4s_tune_wmp.xml" title="Edit source document"> </a></div></div></div></div></div><section class="sect2" id="sec-memory-protection-setup-preparation" data-id-title="Preparing for Workload Memory Protection"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">10.3.1 </span><span class="title-name">Preparing for Workload Memory Protection</span></span> <a title="Permalink" class="permalink" href="cha-memory-protection.html#sec-memory-protection-setup-preparation">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-slesforsap/edit/maintenance/15_SP2/xml/s4s_tune_wmp.xml" title="Edit source document"> </a></div></div></div></div></div><div class="procedure"><div class="procedure-contents"><ol class="procedure" type="1"><li class="step"><p>
      Check if your SAP software (SAP HANA, SAP NetWeaver etc) is installed. The
      group <code class="systemitem">sapsys</code> is needed during
      the package installation of <span class="package">sapwmp</span> later. If you skip
      that part, you will get a warning message (see
      <a class="xref" href="cha-memory-protection.html#adm-order-of-packages" title="Important: Watch out for order of packages">Important: Watch out for order of packages</a>).
     </p></li><li class="step"><p>
      Stop the SAP system:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">systemctl</code> stop sapinit</pre></div><p>
      The service can be enabled, but all SAP processes need to be
      terminated.
     </p></li><li class="step"><p>
      Install the package <span class="package">sapwmp</span>:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">&gt; </code><code class="command">sudo</code> <code class="command">zypper</code> install sapwmp</pre></div><div id="adm-order-of-packages" data-id-title="Watch out for order of packages" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important: Watch out for order of packages</div><p>
       The following message should only appear if no SAP software has been
       installed on the system:
      </p><div class="verbatim-wrap"><pre class="screen">Warning: sapsys group not found warning: group sapsys does not exist - using root</pre></div><p>
       Remove the package <span class="package">sapwmp</span> and install the SAP
       software first before installing <span class="package">sapwmp</span> again.
      </p><p>
       As an alternative, you can fix ownership and permission
       <span class="emphasis"><em>after</em></span> installing the SAP software with:
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">&gt; </code><code class="command">sudo</code> <code class="command">chgrp</code> sapsys /usr/lib/sapwmp/sapwmp-capture &amp;&amp; \
chmod +s /usr/lib/sapwmp/sapwmp-capture</pre></div></div><p>
      The following message can be ignored:
     </p><div class="verbatim-wrap"><pre class="screen">Warning: Found memory controller on v1 hierarchy. Make sure unified hierarchy only is used.</pre></div><p>
      Switching to unified hierarchy is done in the next step.
     </p></li><li class="step"><p>
      Add <code class="varname">systemd.unified_cgroup_hierarchy=true</code> to the
      kernel command line by adding it to
      <code class="varname">GRUB_CMDLINE_LINUX_DEFAULT</code> in
      <code class="filename">/etc/default/grub</code> like:
     </p><div class="verbatim-wrap"><pre class="screen">GRUB_CMDLINE_LINUX_DEFAULT="... systemd.unified_cgroup_hierarchy=true swapaccount=1"</pre></div><p>
      With this change, only cgroup2 controllers will be mounted on
      <code class="filename">/sys/fs/cgroup</code>. Cgroup1 controllers, except the
      memory controller, are still available and can be used though. Tools
      using cgroup1 might not work out of the box any more and might need
      reconfiguration. Also, the required mount structure for cgroup1 needs to
      be provided.
     </p><p>
      The parameter <code class="varname">swapaccount=1</code> is not needed for WMP to
      work, but it aids the analysis in support cases to show the amount of
      swapped out memory for each cgroup.
     </p></li><li class="step"><p>
      Rewrite the GRUB2 configuration:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">&gt; </code><code class="command">sudo</code> <code class="command">grub2-mkconfig</code> -o /boot/grub2/grub.cfg</pre></div><p>
      After reboot (will be done later), the cgroup hierarchy is switched to v2
      (unified hierarchy) only.
     </p></li><li class="step" id="st-conf-memorylow-sap-slice"><p>
      Configure <code class="varname">MemoryLow</code> for the
      <code class="systemitem">SAP.slice</code>:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">&gt; </code><code class="command">sudo</code> <code class="command">systemctl</code> set-property SAP.slice MemoryLow=...</pre></div><p>
      This command creates a drop-in in
      <code class="filename">/etc/systemd/system.control/SAP.slice.d/</code> to set
      <code class="varname">MemoryLow</code>.
     </p><p>
      The <span class="package">sapwmp</span> package includes the <code class="systemitem">systemd</code>
      configuration <code class="systemitem">SAP.slice</code> which creates the cgroup
      of the same name for the SAP instances. <code class="varname">MemoryLow</code> is
      the <code class="systemitem">systemd</code> equivalent of the cgroup parameter
      <code class="varname">memory.low</code> mentioned in the introduction. The value
      for <code class="varname">MemoryLow</code> depends on the type of the SAP
      application and the workload.
     </p><div class="variablelist"><dl class="variablelist"><dt id="id-1.13.9.3.2.6.5.1"><span class="term">For SAP HANA</span></dt><dd><p>
         Since SAP HANA has a Global Allocation Limit, its value can be used
         directly.
        </p></dd><dt id="id-1.13.9.3.2.6.5.2"><span class="term">SAP Application Server (SAP NetWeaver, SAP S/4HANA)</span></dt><dd><p>
         For the Application Server, the sizing for the workload should
         indicate the value for <code class="varname">MemoryLow</code>. The
         <span class="package">sapwmp</span> package contains a monitoring part which
         might be useful to determine <code class="varname">MemoryLow</code>. See
         <a class="xref" href="cha-memory-protection.html#sec-memory-protection-operation-monitor-memory-usage" title="10.6. Monitoring memory usage">Section 10.6, “Monitoring memory usage”</a>.
        </p></dd></dl></div><p>
      Keep in mind:
     </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
        All SAP instances on one host are inside the
        <code class="systemitem">SAP.slice</code>. <code class="varname">MemoryLow</code> must
        cover the amount of memory of <span class="emphasis"><em>all</em></span> instances
        together on that host. You cannot protect SAP systems or their
        instances from each other.
       </p></li><li class="listitem"><p>
        If you are using a database other than SAP HANA, some database processes
        might be part of <code class="systemitem">SAP.slice</code>. Their memory
        consumption needs to be taken into account when determining the
        <code class="varname">MemoryLow</code> value.
       </p></li><li class="listitem"><p>
        Never choose a value for <code class="varname">MemoryLow</code> very close to or
        larger than your physical memory. System services and additional
        installed software require memory too. If they are forced to use swap
        too extensively, at the expense of the SAP application, your system
        can become unresponsive.
       </p></li></ul></div><div id="id-1.13.9.3.2.6.8" data-id-title="Correctly calculate MemoryLow value" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note: Correctly calculate <code class="varname">MemoryLow</code> value</div><p>
       <code class="varname">MemoryLow</code> takes the memory size in bytes. If the
       value is suffixed with K, M, G, or T, the specified memory size is
       parsed as Kibibytes, Mebibytes, Gibibytes, or Tebibytes (with the base
       1024 instead of 1000, see
       <a class="link" href="https://en.wikipedia.org/wiki/Binary_prefix" target="_blank">https://en.wikipedia.org/wiki/Binary_prefix</a>),
       respectively. Alternatively, a percentage value may be specified, which
       is taken relative to the installed physical memory on the system.
      </p><p>
       The underlying cgroup memory controller will round up the value to a
       multiple of the page size. To avoid confusion, set the value for
       <code class="varname">MemoryLow</code> to a multiple of the page size.
      </p></div></li><li class="step"><p>
      Create a backup of each SAP instance profile. Errors in a profile can
      prevent a SAP system from starting.
     </p></li><li class="step"><p>
      For each SAP instance, add the following line to the instance profile
      (usually located in
      <code class="filename">/usr/sap/<em class="replaceable">SID</em>/SYS/profile/</code>)
      after the last <code class="literal">Execute_</code> line:
     </p><div class="verbatim-wrap"><pre class="screen">Execute_20 = local /usr/lib/sapwmp/sapwmp-capture -a</pre></div><p>
      If necessary, increase the number of the Execute statement so that it is
      the highest one, which means that that line is executed last.
     </p><div id="id-1.13.9.3.2.8.4" data-id-title="Editing instance profiles" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important: Editing instance profiles</div><p>
       Edit the instance profiles directly
       <span class="strong"><strong>only</strong></span> if you do not have the profiles
       imported into the database to manage them via the SAP GUI (transaction
       RZ11). If you have imported them, use the SAP GUI to add the lines.
       Profile files located in the file system are overwritten and any manual
       changes would be lost!
      </p></div></li></ol></div></div><p>
    Now the system is ready for a reboot.
   </p></section><section class="sect2" id="sec-memory-protection-reboot-and-verification" data-id-title="Reboot and verification"><div class="titlepage"><div><div><div class="title-container"><h3 class="title"><span class="title-number-name"><span class="title-number">10.3.2 </span><span class="title-name">Reboot and verification</span></span> <a title="Permalink" class="permalink" href="cha-memory-protection.html#sec-memory-protection-reboot-and-verification">#</a></h3><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-slesforsap/edit/maintenance/15_SP2/xml/s4s_tune_wmp.xml" title="Edit source document"> </a></div></div></div></div></div><div class="procedure"><div class="procedure-contents"><ol class="procedure" type="1"><li class="step"><p>
      Reboot the system.
     </p></li><li class="step"><p>
      After rebooting, verify that cgroups v2 has indeed been used:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">grep</code>  cgroup /proc/mounts
cgroup /sys/fs/cgroup cgroup2 rw,nosuid,nodev,noexec,relatime 0 0</pre></div></li><li class="step"><p>
      Verify that the cgroup was created successfully and the low memory value
      has been set:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">&gt; </code><code class="command">systemctl</code> show -p MemoryLow SAP.slice
MemoryLow=18487889920    &lt;- Should be your chosen value (always in bytes)!

# cat /sys/fs/cgroup/SAP.slice/memory.low
18487889920    &lt;- Should be your chosen value!</pre></div><p>
      The variable <code class="varname">MemoryLow</code> can be set to any value, but
      the content of the variable is always a multiple of the page size. Keep
      this in mind if you notice a slight difference between the values.
     </p></li><li class="step"><p>
      Check that all SAP instance processes are in the correct system
      slices/cgroup.
     </p><p>
      If you have not enabled
      <code class="systemitem">sapinit.service</code>
      start the service now. If autostart is not enabled in the instance
      profiles, start the instances before you check.
     </p><p>
      Example:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">systemd-cgls</code> -a /sys/fs/cgroup/SAP.slice
Directory /sys/fs/cgroup/SAP.slice:
|-wmp-rd91fd6b3ca0d4c1183659ef4f9a092fa.scope
| |-3349 sapstart pf=/usr/sap/HA0/ERS10/profile/HA0_ERS10_sapha0er
| `-3375 er.sapHA0_ERS10 pf=/usr/sap/HA0/ERS10/profile/HA0_ERS10_sapha0er N...
|-wmp-r360ebfe09bcd4df4873ef69898576199.scope
| |-3572 sapstart pf=/usr/sap/HA0/SYS/profile/HA0_D01_sapha0ci
| |-3624 dw.sapHA0_D01 pf=/usr/sap/HA0/SYS/profile/HA0_D01_sapha0ci
...</pre></div><p>
      The <code class="systemitem">sapstartsrv</code> process of an instance always
      remains in the user slice of
      <code class="literal"><em class="replaceable">SID</em>adm</code>. Only the
      <code class="systemitem">sapstart</code> process and its
      children will be moved to the target cgroup.
     </p><p>
      For each instance, a directory
      <code class="filename">wmp-r<em class="replaceable">SCOPEID</em>.scope</code> exists
      with all processes of this instance. The
      <em class="replaceable">SCOPEID</em> is a random 128-bit value in
      hexadecimal.
     </p><p>
      The SAP HostAgent is not covered by WMP and remains partly in
      <code class="systemitem">sapinit.slice</code> and partly in the user slice of
      <code class="systemitem">sapadm</code>.
     </p></li><li class="step"><p>
      If the processes are not in the cgroup, check if the
      <code class="literal">Execute</code> lines in the instance profiles are correct.
      Also each instance start should now be logged in the system log
      <code class="filename">/var/log/messages</code>:
     </p><div class="verbatim-wrap"><pre class="screen">...
2020-06-16T18:41:28.317233+02:00 server-03 sapwmp-capture: Found PIDs:
2020-06-16T18:41:28.317624+02:00 server-03 sapwmp-capture:      17001
2020-06-16T18:41:28.317813+02:00 server-03 sapwmp-capture:      16994
2020-06-16T18:41:28.317959+02:00 server-03 sapwmp-capture:      16551
2020-06-16T18:41:28.319423+02:00 server-03 sapwmp-capture: Successful capture into SAP.slice/wmp-r07a27e12d7f2491f8ccb9aeb0e080aaa.scope
2020-06-16T18:41:28.319672+02:00 server-03 systemd[1]: Started wmp-r07a27e12d7f2491f8ccb9aeb0e080aaa.scope.
...</pre></div></li></ol></div></div><p>
    To verify the correct setup, run <code class="command">wmp-check</code>. The script
    checks the setup of Workload Memory Protection:
   </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
      Correct setup of cgroup2.
     </p></li><li class="listitem"><p>
      Ownership and permission of the capture program.
     </p></li><li class="listitem"><p>
      WMP entries of SAP instance profiles.
     </p></li><li class="listitem"><p>
      Correct cgrop of running SAP instance processes.
     </p></li><li class="listitem"><p>
      Correct setup of <code class="systemitem">SAP.slice</code>.
     </p></li><li class="listitem"><p>
      Sane configuration of MemoryLow. However, it cannot determine if the
      MemoryLow value has been chosen wisely.
     </p></li><li class="listitem"><p>
      Setup of the optional memory sampler.
     </p></li><li class="listitem"><p>
      Setup of optional swap accounting.
     </p></li></ul></div><p>
    It assumes SAP instances profiles can be found beneath
    <code class="filename">/usr/sap/<em class="replaceable">SID</em>/SYS/profile/</code>.
   </p></section></section><section class="sect1" id="sec-memory-protection-configuration" data-id-title="Configuring Workload Memory Protection"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">10.4 </span><span class="title-name">Configuring Workload Memory Protection</span></span> <a title="Permalink" class="permalink" href="cha-memory-protection.html#sec-memory-protection-configuration">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-slesforsap/edit/maintenance/15_SP2/xml/s4s_tune_wmp.xml" title="Edit source document"> </a></div></div></div></div></div><p>
   To configure WMP, edit <code class="filename">/etc/sapwmp.conf</code>:
  </p><div class="verbatim-wrap"><pre class="screen"># NOTE: Local changes may be reverted after update of WMP package. Check for
#      .rpmsave file to restore &amp; merge changes.

## Description: Slice unit name where workload is put into
## Type:        string
## Default:     "SAP.slice"
DEFAULT_SLICE="SAP.slice"

## Description: Comma-separated list of command names to which capture is
##              applied (matching against /proc/$PID/stat)
## Type:        string
## Default:     sapstart
PARENT_COMMANDS=sapstart</pre></div><p>
   After any change, restart all SAP instances.
  </p><div id="id-1.13.10.5" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.svg"/><div class="admon-title">Warning</div><p>
    Altering <code class="filename">/etc/sapwmp.conf</code> should not be necessary. Do
    not do it until you know exactly what you are doing!
   </p></div></section><section class="sect1" id="sec-memory-protection-operation-change-the-value-of-memorylow" data-id-title="Changing the value of MemoryLow"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">10.5 </span><span class="title-name">Changing the value of MemoryLow</span></span> <a title="Permalink" class="permalink" href="cha-memory-protection.html#sec-memory-protection-operation-change-the-value-of-memorylow">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-slesforsap/edit/maintenance/15_SP2/xml/s4s_tune_wmp.xml" title="Edit source document"> </a></div></div></div></div></div><p>
   To change the value of <code class="varname">MemoryLow</code> run:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">systemctl</code> set-property SAP.slice MemoryLow=...</pre></div><p>
   The changes will take effect immediately.
  </p><p>
   The underlying cgroup memory controller will round up the value to a
   multiple of the page size. To avoid confusion, set the value of
   <code class="varname">MemoryLow</code> to a multiple of the page size.
  </p><div id="id-1.13.11.6" data-id-title="Value of MemoryLow" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important: Value of <code class="varname">MemoryLow</code></div><p>
    Never set <code class="varname">MemoryLow</code> to a value lower than the memory
    already accounted in <code class="systemitem">SAP.slice</code>. To check, run:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">systemctl</code> show -p MemoryCurrent SAP.slice</pre></div></div></section><section class="sect1" id="sec-memory-protection-operation-monitor-memory-usage" data-id-title="Monitoring memory usage"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">10.6 </span><span class="title-name">Monitoring memory usage</span></span> <a title="Permalink" class="permalink" href="cha-memory-protection.html#sec-memory-protection-operation-monitor-memory-usage">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-slesforsap/edit/maintenance/15_SP2/xml/s4s_tune_wmp.xml" title="Edit source document"> </a></div></div></div></div></div><p>
   Logging the memory usage can be necessary not only to determine the value
   for <code class="varname">memory.low</code>, but also for monitoring the correct
   operation of WMP.
  </p><p>
   To enable monitoring, activate the shipped timer unit:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">systemctl</code> enable --now wmp-sample-memory.timer</pre></div><p>
   Now the timer should be listed by <code class="command">systemctl list-timers</code>:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">systemctl</code> list-timers
NEXT    LEFT       LAST    PASSED  UNIT                     ACTIVATES
...
Tue...  9min left  Tue...  4s ago  wmp-sample-memory.timer  wmp-sample-memory.service
...</pre></div><p>
   If you check the current configuration, you can see that memory data is
   collected every 10 minutes with a randomized delay of
   three minutes:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">systemctl</code> cat wmp-sample-memory.timer
# /usr/lib/systemd/system/wmp-sample-memory.timer
[Unit]
Description=WMP periodic log of memory consumption

[Timer]
OnCalendar=*:0/10
RandomizedDelaySec=180
AccuracySec=60

[Install]
WantedBy=timers.target</pre></div><p>
   To change this, create a drop-in file and reload <code class="systemitem">systemd</code> (for example, by
   increasing the interval to 30 minutes):
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">mkdir</code> /etc/systemd/system/wmp-sample-memory.timer.d

# cat &lt;&lt;EOF &gt;/etc/systemd/system/wmp-sample-memory.timer.d/override.conf
[Timer]
OnCalendar=
OnCalendar=*:0/30
EOF

# systemctl daemon-reload</pre></div><p>
   <span class="emphasis"><em>(The first OnCalendar= line is important for deleting previously
   defined OnCalendar= settings.)</em></span>
  </p><p>
   To see the memory consumption, check the system log for lines written by
   <code class="literal">wmp_memory_current</code>:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">grep</code> wmp_memory_current /var/log/messages
...


2020-09-14T12:02:40.337266+02:00 server-03 wmp_memory_current: SAP.slice : memory.low=21474836480 memory.current=2294059008 memory.swap.current=0 , user.slice : memory.low=0 memory.current=5499219968 memory.swap.current=0 , init.scope : memory.low=0 memory.current=8364032 memory.swap.current=0 , system.slice : memory.low=0 memory.current=1863335936 memory.swap.current=0
2020-09-14T12:03:00.767838+02:00 server-03 wmp_memory_current: SAP.slice : memory.low=21474836480 memory.current=2294022144 memory.swap.current=0 , user.slice : memory.low=0 memory.current=5499473920 memory.swap.current=0 , init.scope : memory.low=0 memory.current=8364032 memory.swap.current=0 , system.slice : memory.low=0 memory.current=1862586368 memory.swap.current=0
2020-09-14T12:04:00.337315+02:00 server-03 wmp_memory_current: SAP.slice : memory.low=21474836480 memory.current=2294022144 memory.swap.current=0 , user.slice : memory.low=0 memory.current=5499207680 memory.swap.current=0 , init.scope : memory.low=0 memory.current=8355840 memory.swap.current=0 , system.slice : memory.low=0 memory.current=1862746112 memory.swap.current=0
...</pre></div><p>
   Here is a reformatted log line to get a better impression:
  </p><div class="verbatim-wrap"><pre class="screen">2020-09-14T12:02:40.337266+02:00 server-03 wmp_memory_current:
SAP.slice    : memory.low=21474836480 memory.current=2294059008 memory.swap.current=0 ,
user.slice   : memory.low=0           memory.current=5499219968 memory.swap.current=0 ,
init.scope   : memory.low=0           memory.current=8364032    memory.swap.current=0 ,
system.slice : memory.low=0           memory.current=1863335936 memory.swap.current=0</pre></div><p>
   For each cgroup directly below <code class="filename">/sys/fs/cgroup/</code> one
   comma-separated block exists. On a normal system, you should find at least
   <code class="systemitem">user.slice</code>, <code class="systemitem">system.slice</code>,
   and <code class="systemitem">init.scope</code>. WMP adds
   <code class="systemitem">SAP.slice</code>.
  </p><p>
   Each block contains the information about the current value of
   <code class="varname">memory.low</code> and <code class="varname">memory.current</code>, and the
   currently allocated amount of physical memory of processes in this cgroup.
  </p><p>
   If you enabled swap accounting (<code class="varname">swapaccount=1</code>) during
   setup, you also have <code class="varname">memory.swap.current</code>, the amount of
   swapped-out memory of the cgroup.
  </p><p>
   All values are in bytes. See <a class="xref" href="cha-memory-protection.html#st-conf-memorylow-sap-slice" title="Step 6">Step 6</a>
   in <a class="xref" href="cha-memory-protection.html#sec-memory-protection-setup-preparation" title="10.3.1. Preparing for Workload Memory Protection">Section 10.3.1, “Preparing for Workload Memory Protection”</a>.
  </p><div id="id-1.13.12.20" data-id-title="Script for printing" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.svg"/><div class="admon-title">Tip: Script for printing</div><p>
    You can find a script to print the information as table or CSV here:
    <a class="link" href="https://github.com/scmschmidt/wmp_log_extract" target="_blank">https://github.com/scmschmidt/wmp_log_extract</a>
   </p></div></section><section class="sect1" id="sec-memory-protection-verify-correct-operation" data-id-title="Verifying correct operation"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">10.7 </span><span class="title-name">Verifying correct operation</span></span> <a title="Permalink" class="permalink" href="cha-memory-protection.html#sec-memory-protection-verify-correct-operation">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-slesforsap/edit/maintenance/15_SP2/xml/s4s_tune_wmp.xml" title="Edit source document"> </a></div></div></div></div></div><p>
   Besides monitoring memory consumption and swapping (see
   <a class="xref" href="cha-memory-protection.html#sec-memory-protection-operation-monitor-memory-usage" title="10.6. Monitoring memory usage">Section 10.6, “Monitoring memory usage”</a>), you
   should also regularly check that all SAP instance processes are in their
   scopes below <code class="systemitem">SAP.slice</code>.
  </p><p>
   To do so, run <code class="command">systemd-cgls</code> and check each instance
   process.
  </p><p>
   Example:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">systemd-cgls</code> -a /sys/fs/cgroup/SAP.slice
Directory /sys/fs/cgroup/SAP.slice:
|-wmp-rd91fd6b3ca0d4c1183659ef4f9a092fa.scope
| |-3349 sapstart pf=/usr/sap/HA0/ERS10/profile/HA0_ERS10_sapha0er
| `-3375 er.sapHA0_ERS10 pf=/usr/sap/HA0/ERS10/profile/HA0_ERS10_sapha0er N...
|-wmp-r360ebfe09bcd4df4873ef69898576199.scope
| |-3572 sapstart pf=/usr/sap/HA0/SYS/profile/HA0_D01_sapha0ci
| |-3624 dw.sapHA0_D01 pf=/usr/sap/HA0/SYS/profile/HA0_D01_sapha0ci
...</pre></div><p>
   A simpler test would be to list all processes, including cgroups, for all
   <code class="literal">SID</code>s used on the system.
  </p><p>
   Example:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">&gt; </code><code class="command">ps</code> -eo user,pid,cgroup:60,args | <code class="command">grep</code> -e [h]a0adm
ha0adm    2062 0::/user.slice/user-1001.slice/user@1001.service/init.scope  /usr/lib/systemd/systemd --user
ha0adm    2065 0::/user.slice/user-1001.slice/user@1001.service/init.scope  (sd-pam)
ha0adm    3081 0::/SAP.slice/wmp-r73c594e050904c9c922a312dd9a28fd4.scope    sapstart pf=/usr/sap/HA0/SYS/profile/HA0_ASCS00_sapha0as
ha0adm    3133 0::/SAP.slice/wmp-r73c594e050904c9c922a312dd9a28fd4.scope    ms.sapHA0_ASCS00 pf=/usr/sap/HA0/SYS/profile/HA0_ASCS00_sapha0as
ha0adm    3134 0::/SAP.slice/wmp-r73c594e050904c9c922a312dd9a28fd4.scope    en.sapHA0_ASCS00 pf=/usr/sap/HA0/SYS/profile/HA0_ASCS00_sapha0as
ha0adm    3327 0::/SAP.slice/wmp-ra42489517eb846c282c57681e627a496.scope    sapstart pf=/usr/sap/HA0/ERS10/profile/HA0_ERS10_sapha0er
...</pre></div><p>
   All instance processes except <code class="systemitem">sapstartsrv</code> need to
   be in a scope below <code class="systemitem">0::/SAP.slice/</code>.
  </p><p>
   To verify the correct setup, use the <code class="command">wmp-check</code> tool. See
   <a class="xref" href="cha-memory-protection.html#sec-memory-protection-reboot-and-verification" title="10.3.2. Reboot and verification">Section 10.3.2, “Reboot and verification”</a> for more
   details.
  </p></section><section class="sect1" id="sec-memory-protection-deinstallation" data-id-title="Uninstalling Workload Memory Protection"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">10.8 </span><span class="title-name">Uninstalling Workload Memory Protection</span></span> <a title="Permalink" class="permalink" href="cha-memory-protection.html#sec-memory-protection-deinstallation">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-slesforsap/edit/maintenance/15_SP2/xml/s4s_tune_wmp.xml" title="Edit source document"> </a></div></div></div></div></div><div class="procedure"><div class="procedure-contents"><ol class="procedure" type="1"><li class="step"><p>
     Stop the SAP system completely. The
     <code class="systemitem">sapinit.service</code> has to be
     stopped, but can stay enabled. All SAP processes have to be terminated.
    </p></li><li class="step"><p>
     Remove any changes made to <code class="systemitem">SAP.slice</code>, such as
     setting <code class="varname">MemoryLow</code>:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">systemctl</code> revert SAP.slice</pre></div></li><li class="step"><p><span class="step-optional">(Optional)</span> 
     Remove the package <span class="package">sapwmp</span>:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">zypper</code> remove sapwmp</pre></div><p>
     This step is optional. The package can stay on the system without having
     an influence.
    </p></li><li class="step"><p><span class="step-optional">(Optional)</span> 
     Remove <code class="varname">systemd.unified_cgroup_hierarchy=true</code> from
     <code class="varname">GRUB_CMDLINE_LINUX_DEFAULT</code> in
     <code class="filename">/etc/default/grub</code>.
    </p><p>
     This step is optional. You can keep cgroup2 without using WMP.
    </p></li><li class="step"><p>
     Rewrite the GRUB2 configuration:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">grub2-mkconfig</code> -o /boot/grub2/grub.cfg</pre></div><p>
     After the next boot, the system is switched back to the hybrid cgroup
     hierarchy.
    </p></li><li class="step"><p>
     Remove the line to call sapwmp-capture from each SAP instance profile
     (usually located in
     <code class="filename">/usr/sap/<em class="replaceable">SID</em>/SYS/profile/</code>):
    </p><div class="verbatim-wrap"><pre class="screen">Execute_20 = local /usr/lib/sapwmp/sapwmp-capture -a</pre></div><div id="id-1.13.14.2.6.3" data-id-title="Backup is necessary" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important: Backup is necessary</div><p>
      Before editing an instance profile, create a backup! Errors in a profile
      can prevent an SAP system from starting!
     </p></div><div id="id-1.13.14.2.6.4" data-id-title="About editing profiles directly" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.svg"/><div class="admon-title">Important: About editing profiles directly</div><p>
      Edit the instance profiles directly
      <span class="strong"><strong>only</strong></span> if you have not imported the
      profiles into the database to manage them via the SAP GUI (transaction
      RZ11). If you have imported them, use the SAP GUI to add the lines.
      Profile files located in the file system are overwritten, and any manual
      changes will be lost!
     </p></div></li><li class="step"><p>
     Reboot the system and verify that your SAP system has been started
     successfully.
    </p></li></ol></div></div></section><section class="sect1" id="sec-sap-systemd-mix-wmp" data-id-title="Systems running both systemd-based and regular SAP instances"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">10.9 </span><span class="title-name">Systems running both <code class="systemitem">systemd</code>-based and regular SAP instances</span></span> <a title="Permalink" class="permalink" href="cha-memory-protection.html#sec-sap-systemd-mix-wmp">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-slesforsap/edit/maintenance/15_SP2/xml/s4s_tune_wmp.xml" title="Edit source document"> </a></div></div></div></div></div><p>
   With SAP kernel version 788 and certain specified patch levels of older
   kernel releases (722, 753, 777, 781, 785), the SAP Start Service supports
   <code class="systemitem">systemd</code>. Such a <code class="systemitem">systemd</code>-based instance comes with its own <code class="systemitem">systemd</code>
   service that the SAP Start Service places into its own cgroup (<code class="systemitem">SAP<em class="replaceable">SID_NR</em>.service</code>)
   under <code class="systemitem">SAP.slice</code>. This affects the
   Workload Memory Protection setup. For <code class="systemitem">systemd</code>-based SAP instances, the following instructions
   apply:
  </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
     Skip the step that adds the capture program to the instance profile. If
     you are migrating an instance to support <code class="systemitem">systemd</code>, remove this entry from
     the profile. Keep in mind that <code class="systemitem">systemd</code>-based instances are always put
     into a cgroup under <code class="systemitem">SAP.slice</code> and
     therefore become part of Workload Memory Protection protection.
    </p></li><li class="listitem"><p>
     Set <code class="option">MemoryLow=infinity</code> for the
     <code class="systemitem">SAP<em class="replaceable">SID_NR</em>.service</code>
     to make the protection work correctly. Example for
     <code class="systemitem">SAPNW1_01.service</code>:
    </p><div class="verbatim-wrap"><pre class="screen">sudo systemctl set-property SAPNW1_01.service MemoryLow=infinity</pre></div></li><li class="listitem"><p>
     Set <code class="option">MemoryLow=infinity</code> for the
     <code class="systemitem">saphostagent.service</code> to make the
     protection work correctly
    </p><div class="verbatim-wrap"><pre class="screen">sudo systemctl set-property saphostagent.service MemoryLow=infinity</pre></div></li></ul></div><p>
   The following example demonstrates a mixed environment. The SAP Host Agent
   and instance 01 are <code class="systemitem">systemd</code>-based, instance 00 is not. Both instances are
   under <code class="systemitem">SAP.slice</code> either in the
   cgroup managed by the SAP Start Service
   (<code class="systemitem">SAPNW1_01.service</code>) or Workload Memory Protection
   (<code class="literal">wmp-rece5b7fa372e4619a9623e120aa23a23.scope</code>).
   <code class="option">MemoryLow=</code> for
   <code class="systemitem">SAP.slice</code> has been set as well as
   <code class="option">MemoryLow=infinity</code> for all the cgroups below.
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">&gt; </code> systemd-cgls
Control group /:
-.slice
├─SAP.slice 
│ ├─SAPNW1_01.service 
│ │ ├─ 887 /usr/sap/NW1/ASCS01/exe/sapstartsrv pf=/usr/sap/NW1/SYS/profile/NW1_ASCS01_systemdproj
│ │ ├─2838 sapstart pf=/usr/sap/NW1/SYS/profile/NW1_ASCS01_systemdproj
│ │ ├─2895 ms.sapNW1_ASCS01 pf=/usr/sap/NW1/SYS/profile/NW1_ASCS01_systemdproj
│ │ └─2896 en.sapNW1_ASCS01 pf=/usr/sap/NW1/SYS/profile/NW1_ASCS01_systemdproj
│ ├─saphostagent.service 
│ │ ├─ 900 /usr/sap/hostctrl/exe/saphostexec pf=/usr/sap/hostctrl/exe/host_profile -nodaemon -trace
│ │ ├─ 984 /usr/sap/hostctrl/exe/sapstartsrv pf=/usr/sap/hostctrl/exe/host_profile
│ │ └─2428 /usr/sap/hostctrl/exe/saposcol -l -w60 pf=/usr/sap/hostctrl/exe/host_profile
│ └─wmp-rece5b7fa372e4619a9623e120aa23a23.scope 
│   ├─5522 sapstart pf=/usr/sap/NW1/SYS/profile/NW1_D00_systemdproj
│   ├─7824 dw.sapNW1_D00 pf=/usr/sap/NW1/SYS/profile/NW1_D00_systemdproj
│   ├─7825 ig.sapNW1_D00 -mode=profile pf=/usr/sap/NW1/SYS/profile/NW1_D00_systemdproj
...

<code class="prompt user">&gt; </code> systemctl show -p MemoryLow SAP.slice
MemoryLow=24584065024

<code class="prompt user">&gt; </code> systemctl show -p MemoryLow wmp-rece5b7fa372e4619a9623e120aa23a23.scope 
MemoryLow=infinity

<code class="prompt user">&gt; </code> systemctl show -p MemoryLow SAPNW1_01.service 
MemoryLow=infinity

<code class="prompt user">&gt; </code> systemctl show -p MemoryLow saphostagent.service 
MemoryLow=infinity</pre></div><p>
   Further information about the <code class="systemitem">systemd</code> integration is available at
   <a class="link" href="https://launchpad.support.sap.com/#/notes/3139184" target="_blank">SAP
   Note 139184 - Linux: <code class="systemitem">systemd</code> integration for sapstartsrv and SAP Host
   Agent</a>.
  </p></section><section class="sect1" id="sec-sap-systemd-wmp" data-id-title="Systems running only systemd-based instances"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">10.10 </span><span class="title-name">Systems running only <code class="systemitem">systemd</code>-based instances</span></span> <a title="Permalink" class="permalink" href="cha-memory-protection.html#sec-sap-systemd-wmp">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-slesforsap/edit/maintenance/15_SP2/xml/s4s_tune_wmp.xml" title="Edit source document"> </a></div></div></div></div></div><div id="id-1.13.16.2" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note</div><p>
    SUSE's HA cluster solutions are supported for fully <code class="systemitem">systemd</code>-based SAP
    systems.
   </p></div><p>
   A SAP system consisting of <code class="systemitem">systemd</code>-based instances can only rely on
   cgroup2 for memory protection.
  </p><p>
   The instances are placed into a dedicated cgroup (default is
   <code class="systemitem">SAP.slice</code>) by the SAP Start
   Service. Therefore it is only necessary to switch to the unified cgroup2
   hierarchy and set <code class="option">MemoryLow=</code> correctly.
  </p><p>
   If Workload Memory Protection is already configured, follow the instructions in
   <a class="xref" href="cha-memory-protection.html#sec-sap-systemd-mix-wmp" title="10.9. Systems running both systemd-based and regular SAP instances">Section 10.9, “Systems running both <code class="systemitem">systemd</code>-based and regular SAP instances”</a>. Afterwards, you can remove the
   package <span class="package">sapwmp</span> from the system, unless you want to use
   the <code class="systemitem">wmp-sample-memory.timer</code> and
   <code class="systemitem">wmp-sample-memory.service</code> to
   monitor memory usage.
  </p><p>
   To configure the memory protection for a system consisting of only
   <code class="systemitem">systemd</code>-based SAP instances, perform the following steps:
  </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
     Stop all SAP instances and the SAP Host Agent.
    </p></li><li class="listitem"><p>
     Switch to the unified cgroup hierarchy, rewrite the boot loader (step 4
     and 5 in <a class="xref" href="cha-memory-protection.html#sec-memory-protection-setup-preparation" title="10.3.1. Preparing for Workload Memory Protection">Section 10.3.1, “Preparing for Workload Memory Protection”</a>).
    </p></li><li class="listitem"><p>
     Set <code class="option">MemoryLow=</code> for
     <code class="systemitem">SAP.slice</code> (step 6 in
     <a class="xref" href="cha-memory-protection.html#sec-memory-protection-setup-preparation" title="10.3.1. Preparing for Workload Memory Protection">Section 10.3.1, “Preparing for Workload Memory Protection”</a>).
    </p></li><li class="listitem"><p>
     Set <code class="option">MemoryLow=infinity</code> for
     <code class="systemitem">saphostagent.service</code> and for the
     services of all SAP instances.
    </p></li><li class="listitem"><p>
     Reboot the system.
    </p></li></ul></div><p>
   The following example demonstrates a <code class="systemitem">systemd</code>-based environment. The SAP
   Host Agent and all instances are in their cgroups under
   <code class="systemitem">SAP.slice</code>.
   <code class="option">MemoryLow=</code> for
   <code class="systemitem">SAP.slice</code> has been set as well as
   <code class="option">MemoryLow=infinity</code> for all the cgroups below.
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">&gt; </code> systemd-cgls
Control group /:
-.slice
├─SAP.slice 
│ ├─SAPNW1_00.service 
│ │ ├─5522 sapstart pf=/usr/sap/NW1/SYS/profile/NW1_D00_systemdproj
│ │ ├─7824 dw.sapNW1_D00 pf=/usr/sap/NW1/SYS/profile/NW1_D00_systemdproj
│ │ ├─7825 ig.sapNW1_D00 -mode=profile pf=/usr/sap/NW1/SYS/profile/NW1_D00_systemdproj
...
│ ├─SAPNW1_01.service 
│ │ ├─ 887 /usr/sap/NW1/ASCS01/exe/sapstartsrv pf=/usr/sap/NW1/SYS/profile/NW1_ASCS01_systemdproj
│ │ ├─2838 sapstart pf=/usr/sap/NW1/SYS/profile/NW1_ASCS01_systemdproj
│ │ ├─2895 ms.sapNW1_ASCS01 pf=/usr/sap/NW1/SYS/profile/NW1_ASCS01_systemdproj
│ │ └─2896 en.sapNW1_ASCS01 pf=/usr/sap/NW1/SYS/profile/NW1_ASCS01_systemdproj
│ └─saphostagent.service 
│   ├─ 900 /usr/sap/hostctrl/exe/saphostexec pf=/usr/sap/hostctrl/exe/host_profile -nodaemon -trace
│   ├─ 984 /usr/sap/hostctrl/exe/sapstartsrv pf=/usr/sap/hostctrl/exe/host_profile
│   └─2428 /usr/sap/hostctrl/exe/saposcol -l -w60 pf=/usr/sap/hostctrl/exe/host_profile
...

<code class="prompt user">&gt; </code> systemctl show -p MemoryLow SAP.slice
MemoryLow=24584065024

<code class="prompt user">&gt; </code> systemctl show -p MemoryLow wmp-rece5b7fa372e4619a9623e120aa23a23.scope 
MemoryLow=infinity

<code class="prompt user">&gt; </code> systemctl show -p MemoryLow SAPNW1_01.service 
MemoryLow=infinity

<code class="prompt user">&gt; </code> systemctl show -p MemoryLow saphostagent.service 
MemoryLow=infinity</pre></div></section></section><nav class="bottom-pagination"><div><a class="pagination-link prev" href="cha-tune.html"><span class="pagination-relation">Previous</span><span class="pagination-label"><span class="title-number">Chapter 9 </span>Tuning systems with <code class="command">saptune</code></span></a> </div><div><a class="pagination-link next" href="cha-access.html"><span class="pagination-relation">Next</span><span class="pagination-label"><span class="title-number">Chapter 11 </span>Firewalling</span></a> </div></nav></article><aside id="_side-toc-page" class="side-toc"><div class="side-title">On this page</div><div class="toc"><ul><li><span class="sect1"><a href="cha-memory-protection.html#sec-memory-protection-architecture"><span class="title-number">10.1 </span><span class="title-name">Architecture</span></a></span></li><li><span class="sect1"><a href="cha-memory-protection.html#sec-memory-protection-support"><span class="title-number">10.2 </span><span class="title-name">Support for Workload Memory Protection</span></a></span></li><li><span class="sect1"><a href="cha-memory-protection.html#sec-memory-protection-setup"><span class="title-number">10.3 </span><span class="title-name">Setting up Workload Memory Protection</span></a></span></li><li><span class="sect1"><a href="cha-memory-protection.html#sec-memory-protection-configuration"><span class="title-number">10.4 </span><span class="title-name">Configuring Workload Memory Protection</span></a></span></li><li><span class="sect1"><a href="cha-memory-protection.html#sec-memory-protection-operation-change-the-value-of-memorylow"><span class="title-number">10.5 </span><span class="title-name">Changing the value of MemoryLow</span></a></span></li><li><span class="sect1"><a href="cha-memory-protection.html#sec-memory-protection-operation-monitor-memory-usage"><span class="title-number">10.6 </span><span class="title-name">Monitoring memory usage</span></a></span></li><li><span class="sect1"><a href="cha-memory-protection.html#sec-memory-protection-verify-correct-operation"><span class="title-number">10.7 </span><span class="title-name">Verifying correct operation</span></a></span></li><li><span class="sect1"><a href="cha-memory-protection.html#sec-memory-protection-deinstallation"><span class="title-number">10.8 </span><span class="title-name">Uninstalling Workload Memory Protection</span></a></span></li><li><span class="sect1"><a href="cha-memory-protection.html#sec-sap-systemd-mix-wmp"><span class="title-number">10.9 </span><span class="title-name">Systems running both <code class="systemitem">systemd</code>-based and regular SAP instances</span></a></span></li><li><span class="sect1"><a href="cha-memory-protection.html#sec-sap-systemd-wmp"><span class="title-number">10.10 </span><span class="title-name">Systems running only <code class="systemitem">systemd</code>-based instances</span></a></span></li></ul></div><div class="side-title">Share this page</div><ul class="share"><li><a id="_share-fb" href="#" title="Facebook"> </a></li><li><a id="_share-in" href="#" title="LinkedIn"> </a></li><li><a id="_share-tw" href="#" title="Twitter/X"> </a></li><li><a id="_share-mail" href="#" title="E-Mail"> </a></li><li><a id="_print-button" href="#" title="Print this page"> </a></li></ul> </aside></main><footer id="_footer"><div class="growth-inhibitor"><div class="copy"><span class="copy__rights">© SUSE
                 2024</span></div></div></footer></body></html>